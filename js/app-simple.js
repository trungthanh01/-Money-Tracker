// js/app-simple.js
// Version ƒë∆°n gi·∫£n - ch·ªâ focus v√†o core functions ho·∫°t ƒë·ªông

// Import t·ª´ data.js
import { 
  addTransaction, 
  editSalary, 
  getTotalBalance,
  getSalary,
  getJars,
  getTransactions,
  formatCurrency,
  JAR_INFO,
  getRatios
} from './data.js';

// === GLOBAL VARIABLES ===
let jarChart = null; // Chart instance

// === BASIC UI FUNCTIONS ===

function updateUI() {
  console.log('üîÑ Updating UI...');
  
  // 1. Update balance
  const totalBalanceEl = document.getElementById('total-balance');
  const totalSalaryEl = document.getElementById('total-salary');
  
  if (totalBalanceEl) totalBalanceEl.textContent = formatCurrency(getTotalBalance());
  if (totalSalaryEl) totalSalaryEl.textContent = formatCurrency(getSalary());
  
  // 2. Update jar cards
  updateJarCards();
  
  // 3. Update transactions
  updateTransactionsList();
  
  // 4. Update chart
  updateChart();
  
  console.log('‚úÖ UI updated');
}

function updateJarCards() {
  const container = document.getElementById('jars-container');
  if (!container) return;
  
  container.innerHTML = '';
  const jars = getJars();
  
  Object.entries(jars).forEach(([jarKey, balance]) => {
    const jarInfo = JAR_INFO[jarKey];
    
    const cardEl = document.createElement('div');
    cardEl.className = 'bg-white rounded-lg shadow-sm p-4 border-l-4';
    cardEl.style.borderLeftColor = jarInfo.color;
    
    cardEl.innerHTML = `
      <div class="flex items-center justify-between mb-2">
        <h4 class="font-semibold text-gray-700">${jarInfo.name}</h4>
        <div class="w-4 h-4 rounded-full" style="background-color: ${jarInfo.color}"></div>
      </div>
      <div class="text-xl font-bold text-gray-900 mb-2">
        ${formatCurrency(balance)}
      </div>
      <p class="text-sm text-gray-500">
        ${jarInfo.description}
      </p>
    `;
    
    container.appendChild(cardEl);
  });
}

function updateTransactionsList() {
  const container = document.getElementById('transactions-list');
  if (!container) return;
  
  const transactions = getTransactions().slice(-5); // 5 giao d·ªãch g·∫ßn nh·∫•t
  
  if (transactions.length === 0) {
    container.innerHTML = '<p class="text-gray-500 text-center">Ch∆∞a c√≥ giao d·ªãch n√†o</p>';
    return;
  }
  
  container.innerHTML = '';
  
  transactions.forEach(transaction => {
    const jarInfo = JAR_INFO[transaction.jar];
    const itemEl = document.createElement('div');
    itemEl.className = 'flex items-center justify-between py-3 border-b border-gray-100';
    
    itemEl.innerHTML = `
      <div class="flex-1">
        <div class="font-medium text-gray-900">${transaction.desc}</div>
        <div class="text-sm text-gray-500">
          ${jarInfo.name} ‚Ä¢ ${transaction.date}
        </div>
      </div>
      <div class="text-right">
        <div class="font-semibold ${transaction.type === 'income' ? 'text-green-600' : 'text-red-600'}">
          ${transaction.type === 'income' ? '+' : '-'}${formatCurrency(Math.abs(transaction.amount))}
        </div>
      </div>
    `;
    
    container.appendChild(itemEl);
  });
}

function updateChart() {
  const canvas = document.getElementById('jar-chart');
  if (!canvas) {
    console.log('‚ùå Canvas not found');
    return;
  }
  
  // Ki·ªÉm tra Chart.js
  if (typeof Chart === 'undefined') {
    console.log('‚ùå Chart.js not loaded, retrying...');
    setTimeout(updateChart, 1000);
    return;
  }
  
  const ctx = canvas.getContext('2d');
  const jars = getJars();
  
  // Prepare data
  const chartData = [];
  const chartLabels = [];
  const chartColors = [];
  
  Object.entries(jars).forEach(([jarKey, balance]) => {
    if (balance > 0) {
      const jarInfo = JAR_INFO[jarKey];
      chartData.push(balance);
      chartLabels.push(jarInfo.name);
      chartColors.push(jarInfo.color);
    }
  });
  
  // Destroy existing chart
  if (jarChart) {
    jarChart.destroy();
  }
  
  // Create new chart
  try {
    jarChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: chartLabels,
        datasets: [{
          data: chartData,
          backgroundColor: chartColors,
          borderWidth: 2,
          borderColor: '#ffffff'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          }
        }
      }
    });
    console.log('‚úÖ Chart created successfully');
  } catch (error) {
    console.error('‚ùå Chart creation failed:', error);
  }
}

// === MODAL FUNCTIONS ===

function showModal(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.classList.remove('hidden');
  }
}

function hideModal(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.classList.add('hidden');
    // Reset form
    const form = modal.querySelector('form');
    if (form) form.reset();
  }
}

function setupTransactionModal(type) {
  const modal = document.getElementById('transaction-modal');
  const title = document.getElementById('modal-title');
  
  if (type === 'income') {
    title.textContent = 'Th√™m Thu Nh·∫≠p';
  } else {
    title.textContent = 'Th√™m Chi Ti√™u';
  }
  
  modal.dataset.transactionType = type;
  showModal('transaction-modal');
}

// === TAB FUNCTIONS ===

function switchTab(activeTabId) {
  // Hide all tabs
  document.querySelectorAll('.tab-content').forEach(tab => {
    tab.classList.add('hidden');
  });
  
  // Remove active from all buttons
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.remove('border-blue-500', 'text-blue-600');
    btn.classList.add('border-transparent', 'text-gray-500');
  });
  
  // Show active tab
  const activeTab = document.getElementById(`${activeTabId}-tab`);
  if (activeTab) {
    activeTab.classList.remove('hidden');
  }
  
  // Activate button
  const activeBtn = document.querySelector(`[data-tab="${activeTabId}"]`);
  if (activeBtn) {
    activeBtn.classList.remove('border-transparent', 'text-gray-500');
    activeBtn.classList.add('border-blue-500', 'text-blue-600');
  }
}

// === EVENT HANDLERS ===

function handleTransactionSubmit(e) {
  e.preventDefault();
  
  try {
    const modal = document.getElementById('transaction-modal');
    const type = modal.dataset.transactionType;
    const amount = document.getElementById('amount-input').value;
    const description = document.getElementById('description-input').value;
    const jar = document.getElementById('jar-select').value;
    
    // Validation
    if (!amount || Number(amount) <= 0) {
      alert('Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn h·ª£p l·ªá');
      return;
    }
    
    if (!description.trim()) {
      alert('Vui l√≤ng nh·∫≠p m√¥ t·∫£');
      return;
    }
    
    if (!jar) {
      alert('Vui l√≤ng ch·ªçn h·ªß');
      return;
    }
    
    // Add transaction
    addTransaction(type, amount, jar, description);
    
    // Update UI
    updateUI();
    
    // Hide modal
    hideModal('transaction-modal');
    
    // Success message
    alert(type === 'income' ? 'ƒê√£ th√™m thu nh·∫≠p!' : 'ƒê√£ th√™m chi ti√™u!');
    
  } catch (error) {
    console.error('Transaction error:', error);
    alert('C√≥ l·ªói x·∫£y ra: ' + error.message);
  }
}

function handleSalarySubmit(e) {
  e.preventDefault();
  
  try {
    const salary = document.getElementById('salary-input').value;
    
    // Get ratios
    const ratios = {
      debt: Number(document.getElementById('debt-ratio').value),
      expenses: Number(document.getElementById('expenses-ratio').value),
      emergency: Number(document.getElementById('emergency-ratio').value),
      savings: Number(document.getElementById('savings-ratio').value),
      investment: Number(document.getElementById('investment-ratio').value),
      learning: Number(document.getElementById('learning-ratio').value)
    };
    
    // Validation
    if (!salary || Number(salary) <= 0) {
      alert('Vui l√≤ng nh·∫≠p l∆∞∆°ng h·ª£p l·ªá');
      return;
    }
    
    const totalRatio = Object.values(ratios).reduce((sum, ratio) => sum + ratio, 0);
    if (totalRatio !== 100) {
      alert('T·ªïng t·ªâ l·ªá ph·∫£i b·∫±ng 100%');
      return;
    }
    
    // Update salary
    editSalary(salary, ratios);
    
    // Update UI
    updateUI();
    
    // Hide modal
    hideModal('salary-modal');
    
    alert('ƒê√£ c·∫≠p nh·∫≠t l∆∞∆°ng!');
    
  } catch (error) {
    console.error('Salary error:', error);
    alert('C√≥ l·ªói x·∫£y ra: ' + error.message);
  }
}

function loadSalaryData() {
  const salary = getSalary();
  const ratios = getRatios();
  
  document.getElementById('salary-input').value = salary;
  document.getElementById('debt-ratio').value = ratios.debt;
  document.getElementById('expenses-ratio').value = ratios.expenses;
  document.getElementById('emergency-ratio').value = ratios.emergency;
  document.getElementById('savings-ratio').value = ratios.savings;
  document.getElementById('investment-ratio').value = ratios.investment;
  document.getElementById('learning-ratio').value = ratios.learning;
  
  updateTotalRatio();
}

function updateTotalRatio() {
  const ratios = [
    'debt-ratio', 'expenses-ratio', 'emergency-ratio',
    'savings-ratio', 'investment-ratio', 'learning-ratio'
  ];
  
  const total = ratios.reduce((sum, id) => {
    const value = Number(document.getElementById(id).value) || 0;
    return sum + value;
  }, 0);
  
  const totalEl = document.getElementById('total-ratio');
  if (totalEl) {
    totalEl.textContent = total + '%';
    totalEl.className = total === 100 ? 'text-green-600' : 'text-red-600';
  }
}

// === INITIALIZATION ===

function bindEvents() {
  console.log('üîó Binding events...');
  
  // Tab buttons
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const tabId = btn.dataset.tab;
      switchTab(tabId);
    });
  });
  
  // Main buttons
  const addIncomeBtn = document.getElementById('btn-add-income');
  if (addIncomeBtn) {
    addIncomeBtn.addEventListener('click', () => setupTransactionModal('income'));
  }
  
  const addExpenseBtn = document.getElementById('btn-add-expense');
  if (addExpenseBtn) {
    addExpenseBtn.addEventListener('click', () => setupTransactionModal('expense'));
  }
  
  const editSalaryBtn = document.getElementById('btn-edit-salary');
  if (editSalaryBtn) {
    editSalaryBtn.addEventListener('click', () => {
      loadSalaryData();
      showModal('salary-modal');
    });
  }
  
  // Forms
  const transactionForm = document.getElementById('transaction-form');
  if (transactionForm) {
    transactionForm.addEventListener('submit', handleTransactionSubmit);
  }
  
  const salaryForm = document.getElementById('salary-form');
  if (salaryForm) {
    salaryForm.addEventListener('submit', handleSalarySubmit);
  }
  
  // Cancel buttons
  const cancelBtns = document.querySelectorAll('#cancel-btn, #cancel-salary-btn');
  cancelBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      hideModal('transaction-modal');
      hideModal('salary-modal');
    });
  });
  
  // Ratio inputs
  const ratioInputs = [
    'debt-ratio', 'expenses-ratio', 'emergency-ratio',
    'savings-ratio', 'investment-ratio', 'learning-ratio'
  ];
  
  ratioInputs.forEach(inputId => {
    const input = document.getElementById(inputId);
    if (input) {
      input.addEventListener('input', updateTotalRatio);
    }
  });
  
  // ESC key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      hideModal('transaction-modal');
      hideModal('salary-modal');
    }
  });
  
  console.log('‚úÖ Events bound');
}

function initApp() {
  console.log('üöÄ Starting Simple Money Tracker...');
  
  // 1. Update UI first
  updateUI();
  
  // 2. Bind events
  bindEvents();
  
  // 3. Show dashboard
  switchTab('dashboard');
  
  // 4. Check first time user
  if (getSalary() === 0) {
    setTimeout(() => {
      alert('Ch√†o m·ª´ng! H√£y nh·∫≠p l∆∞∆°ng ƒë·ªÉ b·∫Øt ƒë·∫ßu.');
      loadSalaryData();
      showModal('salary-modal');
    }, 500);
  }
  
  console.log('‚úÖ Simple Money Tracker Started!');
}

// === APP START ===
document.addEventListener('DOMContentLoaded', initApp);

// Export for debugging
window.SimpleMoneyTracker = {
  updateUI,
  showModal,
  hideModal,
  switchTab
};
